name: Compile and archive

on:
  push:
    tags:
      - '*'  # Trigger for any tag update

permissions:
  contents: write  # Required to create releases

env:
  PDF_FIND_DIR: .
  PDF_FIND_EXPR: -name '*.pdf'

jobs:

  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install TeXLive

        uses: xu-cheng/texlive-action@v3
        with:
          # small scheme = minimal TL; fastest image
          # (requires os: alpine and texlive_version: latest)
          os: alpine
          texlive_version: latest
          scheme: small
          run: |
            # install extra TL collections/packages your docs need
            tlmgr install collection-latexrecommended collection-fontsrecommended latexmk dblfloatfix
            # now build
            make

      # --- Collect PDFs into ./artifacts ---
      - name: Collect PDFs
        run: |
          mkdir -p artifacts
          # Copy discovered PDFs into artifacts/
          find "$PDF_FIND_DIR" -maxdepth 4 -type f \( $PDF_FIND_EXPR \) \
            -not -path './artifacts/*' \
            -print -exec cp -t artifacts {} +
          echo "Collected files:"
          ls -l artifacts || true

      # --- Upload as workflow artifacts ---
      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdfs-${{ github.ref_name }}
          path: artifacts/*.pdf
          if-no-files-found: error

      # --- Create/Update GitHub Release on tag pushes ---
      - name: Create/Update Release and upload PDFs
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # gh CLI uses this
        run: |
          tag="${GITHUB_REF_NAME}"

          # Create release if not existing; otherwise upload assets
          if ! gh release view "$tag" >/dev/null 2>&1; then
            echo "Creating release $tag"
            gh release create "$tag" artifacts/*.pdf \
              --title "$tag" \
              --notes "Automated release for $tag"
          else
            echo "Release $tag exists, uploading assets"
            gh release upload "$tag" artifacts/*.pdf --clobber
          fi
